# Architecture Map

## Root
- `Root/VillainArcApp.swift`
  - App entry point.
  - Creates the main `WindowGroup` with `ContentView`.
  - Injects the SwiftData container via `SharedModelContainer.container`.
  - Refreshes App Shortcuts parameters via `VillainArcShortcuts.updateAppShortcutParameters()` on launch.
  - Handles Spotlight continuations with `onContinueUserActivity(CSSearchableItemActionType)` and routes via `AppRouter` when no session is active.

## Data
- `Data/SharedModelContainer.swift`
  - Central SwiftData container factory shared by the app, router, App Intents, and future widgets.
  - Builds a `Schema` that includes workouts, templates, and supporting models.
  - Uses the App Group container at `group.com.fcttechnologies.VillainArc` and stores `VillainArc.store`.
  - Falls back to the default SwiftData location if the App Group container is unavailable.
  - Notes:
    - Module default actor isolation is `MainActor`, so this container is main-actor isolated by default.
- `Data/SampleData.swift`
  - Preview-only model container and sample data for SwiftUI previews.
  - `@MainActor` initialization and fetch helpers return sample workouts/templates.

## Data / Models
- `Data/Models/Muscle.swift`
  - Muscle enum with major/minor classification and `allMajor` list.
  - `isMajor` is `nonisolated` to allow use in key paths under Swift 6.
- `Data/Models/Exercise.swift`
  - Catalog exercise model with aliases, search index/tokens, and favorite/last-used metadata.
  - Uses `Muscle.isMajor` to format `displayMuscles`.
- `Data/Models/Workout.swift`
  - Workout model with ordering helpers and completion state.
  - Provides summary strings for spoken responses and Spotlight indexing.
- `Data/Models/WorkoutTemplate.swift`
  - Template model with ordering helpers, favorites, and completion state.
  - Provides summary strings for spoken responses and Spotlight indexing.
- `Data/Models/WorkoutExercise.swift`
  - Per-workout exercise with sets, rep/rest policies, and display helpers.
  - Uses `Muscle.isMajor` to choose `displayMuscle`.
- `Data/Models/TemplateExercise.swift`
  - Per-template exercise with sets, rep/rest policies, and display helpers.
  - Uses `Muscle.isMajor` to choose `displayMuscle`.
- `Data/Models/ExerciseCatalog.swift`
  - Static exercise catalog used for seeding and previews.
  - Supports optional aliases for common exercise names.
  - Catalog constants are `nonisolated` for Swift 6 access outside `MainActor`.

## Views
- `Views/ContentView.swift`
  - Entry view for the main UI, hosted by `VillainArcApp`.
  - Injects and uses `AppRouter.shared` for navigation state and full-screen flows.
  - Seeds the exercise catalog via `DataManager.seedExercisesIfNeeded(context:)` on `.task`.
  - Calls `router.checkForUnfinishedData()` to resume in-progress workout/template.
  - Triggers intent donation in `startWorkout()` and `createTemplate()`.
- `Views/WorkoutsListView.swift`
  - Lists completed workouts via `@Query(Workout.completedWorkouts)`.
  - Uses `WorkoutRowView` for each workout row.
  - Deletes workouts and removes Spotlight items before saving via `saveContext(context:)`.
- `Views/Template/TemplatesListView.swift`
  - Lists templates via `@Query(WorkoutTemplate.all)` with favorites filtering.
  - Uses `TemplateRowView` for each template row.
  - Toggles favorites and deletes templates; removes Spotlight items and saves via `saveContext(context:)`.
- `Views/Workout/WorkoutDetailView.swift`
  - Displays a completed workout summary and sets.
  - Uses `AppRouter` to start a workout from an existing one and donates "start last workout again" when applicable.
  - Deletes workouts via `saveContext(context:)` and dismisses the view.
- `Views/Template/TemplateDetailView.swift`
  - Displays a template summary.
  - Uses `AppRouter` to start a workout from a template and donates "start workout with template".
  - Toggles favorites and deletes templates; saves via `saveContext(context:)`.
- `Views/Components/RecentWorkoutSectionView.swift`
  - Shows the most recent completed workout via `@Query(Workout.recentWorkout)`.
  - Navigates to `WorkoutsListView` using `AppRouter`.
  - Donates the "show workout history" and "view last workout" intents.
- `Views/Components/RecentTemplatesSectionView.swift`
  - Shows recent templates via `@Query(WorkoutTemplate.recents)`.
  - Navigates to `TemplatesListView` using `AppRouter` and donates "show templates list".
- `Views/Components/WorkoutRowView.swift`
  - Compact workout card that navigates to `WorkoutDetailView` via `AppRouter`.
- `Views/Components/TemplateRowView.swift`
  - Compact template card that navigates to `TemplateDetailView` via `AppRouter`.
- `Views/Workout/WorkoutView.swift`
  - Main workout session UI with paging vs list modes.
  - Presents sheets for add exercise, rest timer, and settings.
  - Uses `RestTimerState.shared` environment and donates finish/cancel intents on workout completion.
  - Saves/deletes workouts via `saveContext(context:)` and indexes completed workouts in Spotlight.
- `Views/Workout/WorkoutSettingsView.swift`
  - Workout edit/finish sheet; normalizes title and schedules saves.
  - Handles finish actions and delete confirmation.
- `Views/Workout/RestTimerView.swift`
  - Rest timer sheet driven by `RestTimerState` and recent `RestTimeHistory`.
  - Records recent rest times, saves via `saveContext(context:)`, and donates rest timer intents for manual actions.
- `Views/Workout/AddExerciseView.swift`
  - Exercise picker sheet for workouts/templates.
  - Uses `FilteredExerciseListView` and `MuscleFilterSheetView`.
  - Dedupe catalog via `DataManager.dedupeCatalogExercisesIfNeeded(context:)`.
- `Views/Workout/MuscleFilterSheetView.swift`
  - Chip-based muscle filter selector with custom flow layout.
- `Views/Workout/FilteredExerciseListView.swift`
  - Exercise catalog list with search, favorites, and muscle filters.
  - Saves favorite toggles via `saveContext(context:)`.
- `Views/Workout/ExerciseView.swift`
  - Per-exercise editing view used in the workout session.
  - Looks up previous completed sets via `@Query`.
  - Presents `RepRangeEditorView` and `RestTimeEditorView`.
- `Views/Workout/RepRangeEditorView.swift`
  - Sheet to edit rep range policy; saves on changes and on dismiss.
- `Views/Workout/RestTimeEditorView.swift`
  - Sheet to edit rest time policy for an exercise or template exercise.
  - Saves on changes and on dismiss; uses `TimerDurationPicker`.
- `Views/Template/TemplateView.swift`
  - Template editor with add exercise sheet and per-exercise edit sections.
  - Uses `RepRangeEditorView` and `RestTimeEditorView` for template exercises.
  - Confirms cancel/delete when removing the final exercise while editing.

## Data / Classes
- `Data/Classes/AppRouter.swift`
  - `@MainActor` + `@Observable` singleton that owns navigation path and active workout/template.
  - Reads/writes via `SharedModelContainer.container.mainContext`.
  - Starts or resumes workouts/templates, inserts into SwiftData, and saves via `saveContext`.
  - Note: any use from non-main contexts (e.g., App Intents, background tasks) must hop to `MainActor`.

- `Data/Classes/SpotlightIndexer.swift`
  - Indexes completed workouts/templates plus catalog exercises in Core Spotlight and removes entries on delete.
  - Associates App Entities for templates/exercises to improve Spotlight suggestions.
  - Uses stable identifiers with `workout:`, `template:`, and `exercise:` prefixes.

- `Data/Classes/RestTimerState.swift`
  - `@MainActor` + `@Observable` rest timer state persisted in `UserDefaults`.
  - Exposes `shared` singleton for UI + App Intents and schedules auto-stop tasks.

- `Data/Classes/DataManager.swift`
  - `@MainActor` utility for seeding and deduping the exercise catalog.
  - Uses `UserDefaults` versioning, syncs aliases, and updates Spotlight exercise entries.
  - Exposes `saveContext` and `scheduleSave` helpers (main-actor isolated).

## Helpers
- `Helpers/Haptics.swift`
  - `@MainActor` haptics helper that wraps UIKit feedback generators.
  - Used across UI interactions (e.g., selection, success, warning, error).
- `Helpers/TextNormalization.swift`
  - Pure text normalization and fuzzy-search helpers.
  - Marked `nonisolated` for use from model code under Swift 6.

## Intents
- `Intents/IntentDonations.swift`
  - Convenience wrappers for donating App Intents from UI flows, including rest timer and finish/cancel actions.
- `Intents/OpenAppIntent.swift`
  - Opens the app for foregrounding flows.
- `Intents/Template/WorkoutTemplateEntity.swift`
  - Indexed AppEntity for template selection in Shortcuts with Spotlight metadata.
  - Uses `WorkoutTemplate.all` for suggestions and derives summary/keywords from the template.
- `Intents/Exercise/ExerciseEntity.swift`
  - Indexed AppEntity for exercise selection in Shortcuts with alias synonyms and Spotlight metadata.
  - Uses `Exercise.all` for suggestions and exposes aliases as synonyms.
- `Intents/Workout/StartWorkoutIntent.swift`
  - App Intent to start a new empty workout.
  - Uses `SharedModelContainer.container.mainContext` and `AppRouter.shared`.
  - Opens the app via `OpenAppIntent` on success.
- `Intents/Workout/StartWorkoutWithTemplateIntent.swift`
  - App Intent to start a workout from a selected template.
  - Uses `SharedModelContainer.container.mainContext` and `AppRouter.shared`.
  - Opens the app via `OpenAppIntent` on success.
- `Intents/Workout/StartLastWorkoutAgainIntent.swift`
  - App Intent to start a workout based on the most recent completed workout.
  - Uses `SharedModelContainer.container.mainContext` and `AppRouter.shared`.
  - Opens the app via `OpenAppIntent` on success.
- `Intents/Workout/ResumeActiveSessionIntent.swift`
  - App Intent to resume an active workout or template session.
  - Uses `SharedModelContainer.container.mainContext` and `AppRouter.shared`.
  - Opens the app via `OpenAppIntent` on success.
- `Intents/Template/CreateTemplateIntent.swift`
  - App Intent to create or resume a template.
  - Uses `SharedModelContainer.container.mainContext` and `AppRouter.shared`.
  - Opens the app via `OpenAppIntent` on success.
- `Intents/Workout/ViewLastWorkoutIntent.swift`
  - App Intent to navigate to the most recent completed workout.
  - Uses `SharedModelContainer.container.mainContext` and `AppRouter.shared` (pops to root before navigation).
  - Defines `OpenAppIntent` and opens the app after navigation setup.
- `Intents/Workout/ShowWorkoutHistoryIntent.swift`
  - App Intent to open the workouts list via `AppRouter.shared` (pops to root first).
  - Opens the app after navigation setup.
- `Intents/Template/ShowTemplatesListIntent.swift`
  - App Intent to open the templates list via `AppRouter.shared` (pops to root first).
  - Opens the app after navigation setup.
- `Intents/Workout/LastWorkoutSummaryIntent.swift`
  - App Intent that speaks a summary of the last workout without opening the app.
  - Uses `SharedModelContainer.container.mainContext`.
- `Intents/Workout/FinishWorkoutIntent.swift`
  - App Intent that finishes the active workout and stops the rest timer.
  - Saves changes via `SharedModelContainer.container.mainContext`.
- `Intents/Workout/CompleteActiveSetIntent.swift`
  - App Intent that completes the next incomplete set and can auto-start the rest timer.
- `Intents/Exercise/AddExercisesIntent.swift`
  - App Intent that adds selected exercises to the active workout or template.
- `Intents/Exercise/AddExerciseIntent.swift`
  - App Intent that adds a single exercise to the active workout or template.
- `Intents/Workout/CancelWorkoutIntent.swift`
  - App Intent that cancels the active workout and stops the rest timer.
  - Saves changes via `SharedModelContainer.container.mainContext`.
- `Intents/RestTimer/StartRestTimerIntent.swift`
  - App Intent that starts a rest timer for an explicit duration (`Measurement<UnitDuration>`).
  - Requires an active workout and records rest time history.
- `Intents/RestTimer/PauseRestTimerIntent.swift`
  - App Intent that pauses the running rest timer.
- `Intents/RestTimer/ResumeRestTimerIntent.swift`
  - App Intent that resumes the paused rest timer.
- `Intents/RestTimer/StopRestTimerIntent.swift`
  - App Intent that stops any active rest timer.
- `Intents/VillainArcShortcuts.swift`
  - Registers Siri shortcut phrases for all App Intents.
